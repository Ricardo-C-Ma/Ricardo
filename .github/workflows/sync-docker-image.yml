name: Sync Docker Images to Personal ACR

on:
  schedule:
    - cron: '0 2 * * *'  # UTC 时间每天凌晨2点 (北京时间上午10点)
  workflow_dispatch:

env:
  ACR_REGISTRY: crpi-mvnxnutpj57cigam.cn-hangzhou.personal.cr.aliyuncs.com
  ACR_NAMESPACE: ricardolerry

jobs:
  sync-deeplabcut:
    runs-on: ubuntu-latest
    steps:
      # 登录 Docker Hub (修复版 - 单行命令)
      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -username "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin docker.io
      
      # 登录阿里云 ACR (修复版 - 单行命令)
      - name: Login to Alibaba Cloud ACR
        run: echo "${{ secrets.ACR_PASSWORD }}" | docker login -u "${{ secrets.ACR_USERNAME }}" --password-stdin "${{ env.ACR_REGISTRY }}"
      
      # 其他步骤保持不变...
      - name: Pull Docker Image
        run: docker pull deeplabcut/deeplabcut:latest-core
      
      - name: Tag Image
        run: docker tag deeplabcut/deeplabcut:latest-core ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/deeplabcut:latest-core
      
      - name: Push to ACR
        run: docker push ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/deeplabcut:latest-core
      
      - name: Cleanup
        run: |
          docker rmi deeplabcut/deeplabcut:latest-core || true
          docker system prune -f
